# Decentralized Global Iteration System - Architecture Diagram

## System Overview

The decentralized global iteration system eliminates the need for a coordinator by using consensus among all ranks. This provides better fault tolerance, scalability, and eliminates single points of failure.

## Key Components

### 1. External TCPStore (Persistent State)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    External TCPStore                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Global State Keys                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ global_iteration_counter: 42               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ global_iteration_ready: "42"               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ heartbeat_0: "1703123456.789"              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ heartbeat_1: "1703123456.790"              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ heartbeat_2: "1703123456.791"              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ rank_0_last_iteration: "42"                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ rank_1_last_iteration: "42"                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ rank_2_last_iteration: "42"                â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Distributed Ranks (Equal Participants)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Rank 0    â”‚    â”‚   Rank 1    â”‚    â”‚   Rank 2    â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Training â”‚ â”‚    â”‚ â”‚Training â”‚ â”‚    â”‚ â”‚Training â”‚ â”‚
â”‚ â”‚Loop     â”‚ â”‚    â”‚ â”‚Loop     â”‚ â”‚    â”‚ â”‚Loop     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Heartbeatâ”‚ â”‚    â”‚ â”‚Heartbeatâ”‚ â”‚    â”‚ â”‚Heartbeatâ”‚ â”‚
â”‚ â”‚Sender   â”‚ â”‚    â”‚ â”‚Sender   â”‚ â”‚    â”‚ â”‚Sender   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Consensusâ”‚ â”‚    â”‚ â”‚Consensusâ”‚ â”‚    â”‚ â”‚Consensusâ”‚ â”‚
â”‚ â”‚Participantâ”‚ â”‚    â”‚ â”‚Participantâ”‚ â”‚    â”‚ â”‚Participantâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Consensus Protocol Flow

### Phase 1: Training and Heartbeat
```
Time T1: All ranks are training
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 0: Training iteration 42                              â”‚
â”‚ Rank 1: Training iteration 42                              â”‚
â”‚ Rank 2: Training iteration 42                              â”‚
â”‚                                                             â”‚
â”‚ All ranks send heartbeats every 5 seconds                  â”‚
â”‚ TCPStore: heartbeat_0, heartbeat_1, heartbeat_2 updated    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: Ready for Next Iteration
```
Time T2: Ranks complete training, ready for iteration 43
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 0: append("global_iteration_barrier:arrived", "0,")   â”‚
â”‚ Rank 1: append("global_iteration_barrier:arrived", "1,")   â”‚
â”‚ Rank 2: append("global_iteration_barrier:arrived", "2,")   â”‚
â”‚                                                             â”‚
â”‚ TCPStore: global_iteration_barrier:arrived = "0,1,2,"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 3: Active Rank Detection
```
Time T3: System detects active ranks
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ All ranks call get_active_ranks_for_coordination()         â”‚
â”‚                                                             â”‚
â”‚ Check heartbeats:                                          â”‚
â”‚ - Rank 0: heartbeat_0 = 1703123456.789 (active)           â”‚
â”‚ - Rank 1: heartbeat_1 = 1703123456.790 (active)           â”‚
â”‚ - Rank 2: heartbeat_2 = 1703123456.791 (active)           â”‚
â”‚                                                             â”‚
â”‚ Active ranks: {0, 1, 2}                                    â”‚
â”‚ Arrived ranks: {0, 1, 2}                                   â”‚
â”‚ Consensus: All active ranks have arrived                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 4: Consensus Competition
```
Time T4: All ranks compete for consensus
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 0: set("global_iteration_barrier:consensus", "0")     â”‚
â”‚ Rank 1: set("global_iteration_barrier:consensus", "1")     â”‚
â”‚ Rank 2: set("global_iteration_barrier:consensus", "2")     â”‚
â”‚                                                             â”‚
â”‚ TCPStore: global_iteration_barrier:consensus = "1"         â”‚
â”‚ (Rank 1 won the race condition)                            â”‚
â”‚                                                             â”‚
â”‚ Rank 0: Lost consensus, waits for new iteration            â”‚
â”‚ Rank 1: Won consensus, advances iteration                  â”‚
â”‚ Rank 2: Lost consensus, waits for new iteration            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 5: Iteration Advancement
```
Time T5: Consensus winner advances iteration
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 1 (winner):                                           â”‚
â”‚ 1. increment_global_iteration() â†’ 43                       â”‚
â”‚ 2. record_iteration_for_rank(0, 43)                       â”‚
â”‚ 3. record_iteration_for_rank(1, 43)                       â”‚
â”‚ 4. record_iteration_for_rank(2, 43)                       â”‚
â”‚ 5. clear_global_iteration_ready()                         â”‚
â”‚ 6. signal_global_iteration_ready(43)                      â”‚
â”‚                                                             â”‚
â”‚ TCPStore:                                                  â”‚
â”‚ - global_iteration_counter: 43                             â”‚
â”‚ - global_iteration_ready: "43"                             â”‚
â”‚ - rank_0_last_iteration: "43"                              â”‚
â”‚ - rank_1_last_iteration: "43"                              â”‚
â”‚ - rank_2_last_iteration: "43"                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 6: All Ranks Continue
```
Time T6: All ranks receive new iteration
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 0: wait([global_iteration_ready]) â†’ receives 43       â”‚
â”‚ Rank 1: Already has 43 (consensus winner)                  â”‚
â”‚ Rank 2: wait([global_iteration_ready]) â†’ receives 43       â”‚
â”‚                                                             â”‚
â”‚ All ranks: Continue training with iteration 43             â”‚
â”‚                                                             â”‚
â”‚ TCPStore: Cleaned up barrier state                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Fault Tolerance Scenarios

### Scenario 1: Rank Crash During Training
```
Time T1: Rank 1 crashes due to GPU error
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 0: Training iteration 42                              â”‚
â”‚ Rank 1: âŒ CRASHED (GPU error)                             â”‚
â”‚ Rank 2: Training iteration 42                              â”‚
â”‚                                                             â”‚
â”‚ TCPStore: heartbeat_1 stops updating                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time T2: Remaining ranks detect crash
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ get_active_ranks_for_coordination():                       â”‚
â”‚ - Rank 0: heartbeat_0 = recent (active)                   â”‚
â”‚ - Rank 1: heartbeat_1 = old (inactive)                    â”‚
â”‚ - Rank 2: heartbeat_2 = recent (active)                   â”‚
â”‚                                                             â”‚
â”‚ Active ranks: {0, 2} (Rank 1 excluded)                    â”‚
â”‚ Consensus: Proceeds with 2/3 ranks                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario 2: Early Restart Race Condition
```
Time T1: Rank 1 crashes, iteration = 42
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 0: Training iteration 42                              â”‚
â”‚ Rank 1: âŒ CRASHED                                         â”‚
â”‚ Rank 2: Training iteration 42                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time T2: Rank 1 restarts before iteration advances
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 0: Ready for iteration 43                             â”‚
â”‚ Rank 1: ğŸ”„ RESTARTED (iteration = 42)                      â”‚
â”‚ Rank 2: Ready for iteration 43                             â”‚
â”‚                                                             â”‚
â”‚ Rank 1: handle_rank_restart()                              â”‚
â”‚ - Gets previous iteration: 42                              â”‚
â”‚ - Sends heartbeat                                          â”‚
â”‚ - Checks if iteration advanced during restart              â”‚
â”‚ - Detects iteration is still 42 (no race condition)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time T3: Iteration advances to 43
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 0: Wins consensus, advances to 43                     â”‚
â”‚ Rank 1: Detects iteration advanced to 43                   â”‚
â”‚ Rank 2: Receives iteration 43                              â”‚
â”‚                                                             â”‚
â”‚ Rank 1: catch_up_restarting_rank() â†’ gets 43              â”‚
â”‚ All ranks: Continue with iteration 43                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Benefits of Decentralized Approach

### 1. No Single Point of Failure
```
âŒ Coordinator-Based:                    âœ… Decentralized:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Coordinator â”‚                         â”‚ All Ranks   â”‚
â”‚ (Rank 0)    â”‚                         â”‚ Equal       â”‚
â”‚             â”‚                         â”‚             â”‚
â”‚ Single      â”‚                         â”‚ No Single   â”‚
â”‚ Point of    â”‚                         â”‚ Point of    â”‚
â”‚ Failure     â”‚                         â”‚ Failure     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Automatic Fault Detection
```
Heartbeat Monitoring:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Every 5 seconds:                                           â”‚
â”‚ Rank 0: send_heartbeat(0) â†’ heartbeat_0 = timestamp       â”‚
â”‚ Rank 1: send_heartbeat(1) â†’ heartbeat_1 = timestamp       â”‚
â”‚ Rank 2: send_heartbeat(2) â†’ heartbeat_2 = timestamp       â”‚
â”‚                                                             â”‚
â”‚ Detection:                                                 â”‚
â”‚ - If heartbeat_1 > 30 seconds old â†’ Rank 1 inactive       â”‚
â”‚ - Exclude from active_ranks set                           â”‚
â”‚ - Continue with remaining ranks                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Consensus-Based Coordination
```
Atomic Consensus:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Multiple ranks try to set consensus flag:                  â”‚
â”‚                                                             â”‚
â”‚ Rank 0: set(consensus_key, "0") â†’ Success?                â”‚
â”‚ Rank 1: set(consensus_key, "1") â†’ Success?                â”‚
â”‚ Rank 2: set(consensus_key, "2") â†’ Success?                â”‚
â”‚                                                             â”‚
â”‚ Only ONE rank succeeds (atomic operation)                  â”‚
â”‚ Winner advances iteration, others wait                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Transitions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    State Machine                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Training    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Ready     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚Training â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Ready   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚Consensusâ”‚
â”‚  â”‚         â”‚                â”‚         â”‚              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚       â–²                          â”‚                        â”‚
â”‚       â”‚                          â”‚                        â”‚
â”‚       â”‚                    Consensus                     â”‚
â”‚       â”‚                      Winner                      â”‚
â”‚       â”‚                        â”‚                         â”‚
â”‚       â”‚                        â–¼                         â”‚
â”‚       â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚       â”‚                  â”‚Advance  â”‚                    â”‚
â”‚       â”‚                  â”‚Iterationâ”‚                    â”‚
â”‚       â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚       â”‚                        â”‚                         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                â”‚
â”‚                                â–¼
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â”‚ New     â”‚
â”‚                          â”‚Iterationâ”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Summary

The decentralized approach provides:

1. **Equal Participation**: All ranks participate equally in consensus
2. **Fault Tolerance**: System continues with any subset of active ranks
3. **No Coordinator**: Eliminates single point of failure
4. **Automatic Recovery**: Crashed ranks are detected and excluded
5. **Race Condition Handling**: Restarting ranks can catch up
6. **Scalability**: No bottleneck through a single coordinator

This design is simpler, more robust, and more scalable than coordinator-based approaches. 